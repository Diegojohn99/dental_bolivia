<div class="py-4 space-y-4">
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
    <div>
      <h1 class="text-2xl font-semibold text-dental-primary">Agenda de citas</h1>
      <p class="text-sm text-gray-300">Vista mensual de las citas de la clínica.</p>
      <p class="text-xs text-gray-500 mt-1">Hoy es <%= l Date.current, format: "%d/%m/%Y" %>.</p>
    </div>
    <div class="flex items-center justify-end gap-2">
      <%= link_to "Nueva cita", new_appointment_path, class: "inline-flex items-center px-4 py-2 bg-dental-primary text-white rounded-md text-sm hover:bg-sky-600" %>
    </div>
  </div>

  <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-3 text-xs md:text-sm text-gray-200 gap-2">
    <div class="flex flex-wrap items-center gap-x-4 gap-y-1">
      <span class="inline-flex items-center"><span class="w-3 h-3 rounded bg-dental-secondary mr-1"></span>Confirmada</span>
      <span class="inline-flex items-center"><span class="w-3 h-3 rounded bg-dental-accent mr-1"></span>Programada</span>
      <span class="inline-flex items-center"><span class="w-3 h-3 rounded bg-emerald-500 mr-1"></span>Completada</span>
      <span class="inline-flex items-center"><span class="w-3 h-3 rounded bg-red-500 mr-1"></span>Cancelada</span>
    </div>

    <div>
      <%= form_with url: appointments_path, method: :get, local: true, class: "flex items-center space-x-2" do |f| %>
        <span class="text-xs text-gray-500">Dentista:</span>
        <%= f.select :dentist_id,
                     options_for_select([["Todos", ""]] + @dentists.map { |d| [d.name, d.id] }, params[:dentist_id]),
                     {},
                     class: "border-gray-300 rounded-md text-xs md:text-sm" %>
        <%= f.submit "Filtrar", class: "px-2 py-1 text-xs bg-gray-100 rounded-md hover:bg-gray-200" %>
      <% end %>
    </div>
  </div>

  <% current_month = params[:start_date].present? ? Date.parse(params[:start_date]) : Date.current %>
  <div class="bg-white/95 shadow rounded-2xl p-3 md:p-6">
    <div class="flex items-center justify-between mb-2 text-xs md:text-sm text-gray-700">
      <div class="font-semibold"><%= l current_month, format: "%B %Y" %></div>
      <div class="space-x-1">
        <%= link_to "Previous", appointments_path(start_date: current_month.prev_month),
                    class: "inline-flex items-center px-2 py-1 rounded-full border border-gray-300 bg-gray-50 hover:bg-gray-100" %>
        <%= link_to "Today", appointments_path,
                    class: "inline-flex items-center px-2 py-1 rounded-full border border-gray-300 bg-gray-50 hover:bg-gray-100" %>
        <%= link_to "Next", appointments_path(start_date: current_month.next_month),
                    class: "inline-flex items-center px-2 py-1 rounded-full border border-gray-300 bg-gray-50 hover:bg-gray-100" %>
      </div>
    </div>

    <div class="w-full">
      <%= month_calendar attribute: :scheduled_at,
                         events: @appointments,
                         table: { class: "w-full border-collapse table-fixed" },
                         tr: { class: "" },
                         th: { class: "py-2 px-1 text-center font-semibold text-gray-700 text-xs md:text-sm border border-gray-200 bg-gray-50" },
                         td: { class: "align-top p-2 border border-gray-200 h-28 md:h-36 lg:h-40" },
                         previous_link: "",
                         next_link: "",
                         today_link: "" do |date, appointments| %>

        <div class="flex flex-col h-full">
          <div class="flex items-center justify-between mb-1 flex-shrink-0">
            <span class="text-xs md:text-sm font-semibold <%= date.today? ? 'text-dental-primary' : 'text-gray-700' %>">
              <%= date.day %>
            </span>
            <% if date.today? %>
              <span class="text-[9px] md:text-[10px] px-1 py-0.5 rounded bg-dental-primary text-white">Hoy</span>
            <% end %>
          </div>

          <% if appointments.empty? %>
            <p class="text-[10px] md:text-xs text-gray-400">Sin citas</p>
          <% else %>
            <div class="space-y-1 overflow-y-auto flex-1 scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-transparent">
              <% appointments.each do |appointment| %>
                <% badge_class = if appointment.cancelled?
                                   'bg-red-500 text-white'
                                 elsif appointment.completed?
                                   'bg-emerald-500 text-white'
                                 elsif appointment.confirmed?
                                   'bg-dental-secondary text-white'
                                 else
                                   'bg-dental-accent text-white'
                                 end %>

                <div class="px-1.5 py-1 rounded text-[10px] md:text-xs <%= badge_class %> hover:opacity-90 transition-opacity cursor-pointer">
                  <div class="font-semibold truncate"><%= appointment.patient.name %></div>
                  <div class="truncate opacity-95"><%= appointment.service_type %></div>
                  <div class="opacity-90 text-[9px] md:text-[10px]"><%= l appointment.scheduled_at, format: "%H:%M" %></div>
                </div>
              <% end %>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>

  <% todays_appointments = @appointments.select { |a| a.scheduled_at&.to_date == Date.current } %>

  <div class="mt-6 bg-white shadow rounded-lg p-4">
    <h2 class="text-lg font-semibold text-dental-primary mb-2">Citas de hoy</h2>
    <% if todays_appointments.empty? %>
      <p class="text-sm text-gray-500">No hay citas programadas para hoy.</p>
    <% else %>
      <ul class="divide-y divide-gray-100">
        <% todays_appointments.each do |appointment| %>
          <li class="py-2 flex items-center justify-between text-sm">
            <div>
              <p class="font-medium"><%= appointment.patient.name %> · <%= appointment.service_type %></p>
              <p class="text-gray-500">
                <%= l appointment.scheduled_at, format: "%H:%M" %> ·
                <%= appointment.dentist.name %>
              </p>
            </div>
            <div class="flex items-center space-x-2">
              <%= link_to "Editar", edit_appointment_path(appointment), class: "px-2 py-1 text-xs border rounded-md hover:bg-gray-50" %>
              <%= button_to "Enviar recordatorio", send_reminder_appointment_path(appointment), method: :post,
                            class: "px-2 py-1 text-xs bg-gray-800 text-white rounded-md hover:bg-gray-700" %>
              <% if appointment.invoice.present? %>
                <%= link_to "Ver factura", invoice_path(appointment.invoice), class: "px-2 py-1 text-xs bg-dental-primary text-white rounded-md hover:bg-sky-600" %>
                <% if appointment.invoice.paid? %>
                  <span class="text-[11px] text-emerald-500 font-semibold">Pagada</span>
                <% else %>
                  <span class="text-[11px] text-yellow-500 font-semibold">Pendiente</span>
                <% end %>
              <% else %>
                <%= link_to "Generar factura", generate_invoice_appointment_path(appointment), class: "px-2 py-1 text-xs bg-dental-accent text-white rounded-md hover:bg-blue-600" %>
              <% end %>
            </div>
          </li>
        <% end %>
      </ul>
    <% end %>
  </div>
</div>